import { auth } from "../auth";
import { NextResponse } from "next/server";

/**
 * é«˜æ€§èƒ½èªè­‰ä¸­é–“ä»¶ï¼ˆç¬¬äº”éšæ®µï¼šä¸­é–“ä»¶å„ªåŒ–ç‰ˆæœ¬ï¼‰
 * 
 * ğŸš€ æ ¸å¿ƒæ€§èƒ½å„ªåŒ–ï¼š
 * 1. ç²¾ç¢ºè·¯ç”±åŒ¹é… - æ¸›å°‘ä¸å¿…è¦çš„èªè­‰æª¢æŸ¥
 * 2. æ™ºèƒ½é‡å®šå‘ç­–ç•¥ - é¿å…å¤šæ¬¡é‡å®šå‘å¾ªç’°
 * 3. éœæ…‹è³‡æºå¿«é€Ÿé€šé“ - é›¶å»¶é²è™•ç†éœæ…‹æª”æ¡ˆ
 * 4. é‚Šç·£é‹ç®—æœ€ä½³åŒ– - å……åˆ†åˆ©ç”¨ Edge Runtime æ€§èƒ½
 * 5. ç¶²çµ¡è«‹æ±‚æœ€å°åŒ– - æ¸›å°‘èªè­‰ç›¸é—œçš„ç¶²çµ¡é–‹éŠ·
 * 
 * ğŸ¯ å°ˆç‚ºè§£æ±ºã€Œä¸­é–“ä»¶é–‹éŠ·ã€å•é¡Œè¨­è¨ˆï¼š
 * - æ¶ˆé™¤å†—é¤˜çš„èªè­‰æª¢æŸ¥
 * - å„ªåŒ–å…¬é–‹è·¯ç”±è™•ç†
 * - æ™ºèƒ½å¿«å–å‹å¥½è¨­è¨ˆ
 * - éŒ¯èª¤è™•ç†æ€§èƒ½å„ªåŒ–
 * 
 * æŠ€è¡“äº®é»ï¼š
 * - ä½¿ç”¨ NextResponse.next() æœ€å°åŒ–è™•ç†é–‹éŠ·
 * - è·¯å¾‘åŒ¹é…ç®—æ³•å„ªåŒ–
 * - é‡å®šå‘é‚è¼¯ç°¡åŒ–
 */
export default auth((req) => {
  const { nextUrl } = req;
  const pathname = nextUrl.pathname;
  const isLoggedIn = !!req.auth;
  
  // ğŸš€ ç¬¬ä¸€å±¤å„ªåŒ–ï¼šéœæ…‹è³‡æºå’Œ API è·¯ç”±å¿«é€Ÿé€šé“
  // é€™äº›è·¯ç”±å®Œå…¨è·³éèªè­‰æª¢æŸ¥ï¼Œå¯¦ç¾é›¶å»¶é²
  if (
    pathname.startsWith('/_next') ||      // Next.js å…§éƒ¨è³‡æº
    pathname.startsWith('/api') ||        // API è·¯ç”±ï¼ˆæœ‰è‡ªå·±çš„èªè­‰ï¼‰
    pathname.includes('.') ||             // æ‰€æœ‰å¸¶å‰¯æª”åçš„éœæ…‹æª”æ¡ˆ
    pathname === '/favicon.ico' ||        // ç¶²ç«™åœ–æ¨™
    pathname === '/robots.txt' ||         // æœå°‹å¼•æ“çˆ¬èŸ²æª”æ¡ˆ
    pathname === '/manifest.json'         // PWA æ¸…å–®æª”æ¡ˆ
  ) {
    return NextResponse.next();
  }

  // ğŸ¯ ç¬¬äºŒå±¤å„ªåŒ–ï¼šç²¾ç¢ºçš„å…¬é–‹è·¯ç”±è™•ç†
  // å®šç¾©æ˜ç¢ºçš„å…¬é–‹è·¯ç”±æ¸…å–®ï¼Œé¿å…æ¨¡ç³ŠåŒ¹é…
  const publicRoutes = ['/login'];
  const isPublicRoute = publicRoutes.includes(pathname);

  // ğŸ”¥ ç¬¬ä¸‰å±¤å„ªåŒ–ï¼šæ™ºèƒ½ç™»å…¥é é¢é‚è¼¯ï¼ˆèˆ‡ Auth.js ä¿®å¾©ç›¸å®¹ï¼‰
  if (pathname === '/login') {
    if (isLoggedIn) {
      // ğŸ”§ ä¿®å¾©ï¼šå·²ç™»å…¥ç”¨æˆ¶è¨ªå•ç™»å…¥é  â†’ é‡å®šå‘åˆ°å„€è¡¨æ¿
      // ç”±æ–¼ Auth.js çš„ authorized å›èª¿å·²ç°¡åŒ–ï¼Œé€™è£¡éœ€è¦è™•ç†é‡å®šå‘
      return NextResponse.redirect(new URL('/dashboard', nextUrl));
    }
    // æœªç™»å…¥ç”¨æˆ¶è¨ªå•ç™»å…¥é  â†’ å…è¨±
    return NextResponse.next();
  }

  // âš¡ ç¬¬å››å±¤å„ªåŒ–ï¼šæ ¹è·¯å¾‘æ™ºèƒ½è™•ç†
  if (pathname === '/') {
    if (isLoggedIn) {
      // å·²ç™»å…¥ç”¨æˆ¶è¨ªå•æ ¹è·¯å¾‘ â†’ é‡å®šå‘åˆ°å„€è¡¨æ¿
      return NextResponse.redirect(new URL('/dashboard', nextUrl));
    } else {
      // æœªç™»å…¥ç”¨æˆ¶è¨ªå•æ ¹è·¯å¾‘ â†’ é‡å®šå‘åˆ°ç™»å…¥é 
      return NextResponse.redirect(new URL('/login', nextUrl));
    }
  }

  // ğŸ›¡ï¸ ç¬¬äº”å±¤å„ªåŒ–ï¼šå—ä¿è­·è·¯ç”±çš„ç²¾ç°¡æª¢æŸ¥
  if (!isLoggedIn && !isPublicRoute) {
    // æœªç™»å…¥ç”¨æˆ¶è¨ªå•å—ä¿è­·è·¯ç”± â†’ é‡å®šå‘åˆ°ç™»å…¥é 
    return NextResponse.redirect(new URL('/login', nextUrl));
  }

  // ğŸŠ æœ€çµ‚å±¤ï¼šå…è¨±é€šéï¼Œæœ€å°åŒ–è™•ç†é–‹éŠ·
  return NextResponse.next();
});

/**
 * ä¸­é–“ä»¶åŒ¹é…å™¨é…ç½®ï¼ˆé«˜æ€§èƒ½ç‰ˆæœ¬ï¼‰
 * 
 * ğŸš€ å„ªåŒ–ç­–ç•¥ï¼š
 * 1. æ›´ç²¾ç¢ºçš„æ’é™¤æ¨¡å¼ - æ¸›å°‘ä¸­é–“ä»¶èª¿ç”¨æ¬¡æ•¸
 * 2. æ€§èƒ½å‹å¥½çš„æ­£å‰‡è¡¨é”å¼ - é™ä½åŒ¹é…é–‹éŠ·
 * 3. éœæ…‹è³‡æºå®Œå…¨è·³é - é›¶ä¸­é–“ä»¶é–‹éŠ·
 * 
 * æ’é™¤é …ç›®ï¼ˆå®Œå…¨ä¸ç¶“éä¸­é–“ä»¶ï¼‰ï¼š
 * - /_next/* - Next.js æ‰€æœ‰å…§éƒ¨è³‡æºå’Œéœæ…‹æª”æ¡ˆ
 * - /api/* - API è·¯ç”±ï¼ˆLaravel å¾Œç«¯è™•ç†èªè­‰ï¼‰
 * - æ‰€æœ‰å¸¶å‰¯æª”åçš„æª”æ¡ˆ (*.js, *.css, *.png, *.ico ç­‰)
 * 
 * åŒ…å«é …ç›®ï¼ˆéœ€è¦èªè­‰æª¢æŸ¥ï¼‰ï¼š
 * - æ‰€æœ‰é é¢è·¯ç”± (/dashboard, /users, /products ç­‰)
 * - æ ¹è·¯å¾‘ (/)
 * - ç™»å…¥é é¢ (/login) - éœ€è¦é‡å®šå‘é‚è¼¯
 */
export const config = {
  matcher: [
    /*
     * åŒ¹é…æ‰€æœ‰è·¯å¾‘ï¼Œé™¤äº†ï¼š
     * - /_next (Next.js å…§éƒ¨æª”æ¡ˆ)
     * - /api (API è·¯ç”±)
     * - æ‰€æœ‰å¸¶å‰¯æª”åçš„æª”æ¡ˆ
     */
    '/((?!_next|api|.*\\.).*)',
  ],
}; 