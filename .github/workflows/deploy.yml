name: Deploy to Google Cloud

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy (ignore cache)'
        required: false
        default: 'false'
      deploy_target:
        description: 'Deploy target (api/client/both)'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - api
          - client

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
  CLOUD_SQL_CONNECTION_NAME: ${{ secrets.CLOUD_SQL_CONNECTION_NAME }}
  API_SERVICE_NAME: inventory-api
  CLIENT_SERVICE_NAME: inventory-client
  REGION: asia-east1

jobs:
  # æª¢æ¸¬è®Šæ›´çš„æª”æ¡ˆå’Œå€‰åº«é©—è­‰
  detect-changes:
    name: 'Detect Changes'
    runs-on: ubuntu-latest
    # ğŸ” é™åˆ¶åªåœ¨æŒ‡å®šå€‰åº«åŸ·è¡Œ
    if: github.repository == 'lomismoney/Mir01'
    outputs:
      api-changed: ${{ steps.changes.outputs.api }}
      client-changed: ${{ steps.changes.outputs.client }}
      client-needs-deploy: ${{ steps.changes.outputs.client-needs-deploy }}
      force-deploy: ${{ github.event.inputs.force_deploy == 'true' }}
      deploy-target: ${{ github.event.inputs.deploy_target || 'auto' }}
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 'Detect file changes and dependencies'
        id: changes
        run: |
          # åˆå§‹åŒ–è®Šæ›´æª¢æ¸¬è®Šæ•¸
          API_CHANGED=false
          CLIENT_CHANGED=false
          
          echo "ğŸ” æª¢æŸ¥å€‰åº«: ${{ github.repository }}"
          echo "âœ… å€‰åº«é©—è­‰é€šé: ${{ github.repository }}"
          
          if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            echo "api=true" >> $GITHUB_OUTPUT
            echo "client=true" >> $GITHUB_OUTPUT
            echo "client-needs-deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ å¼·åˆ¶éƒ¨ç½² - æ‰€æœ‰æœå‹™å°‡è¢«é‡æ–°éƒ¨ç½²"
            exit 0
          fi

          # ğŸ¯ è™•ç†æ‰‹å‹•éƒ¨ç½²ç›®æ¨™
          DEPLOY_TARGET="${{ github.event.inputs.deploy_target || 'auto' }}"
          if [ "$DEPLOY_TARGET" == "api" ]; then
            echo "api=true" >> $GITHUB_OUTPUT
            echo "client=false" >> $GITHUB_OUTPUT
            echo "client-needs-deploy=false" >> $GITHUB_OUTPUT
            echo "ğŸ¯ æ‰‹å‹•æŒ‡å®šéƒ¨ç½² API only"
            exit 0
          elif [ "$DEPLOY_TARGET" == "client" ]; then
            echo "api=false" >> $GITHUB_OUTPUT
            echo "client=true" >> $GITHUB_OUTPUT
            echo "client-needs-deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸ¯ æ‰‹å‹•æŒ‡å®šéƒ¨ç½² Client only"
            exit 0
          elif [ "$DEPLOY_TARGET" == "both" ]; then
            echo "api=true" >> $GITHUB_OUTPUT
            echo "client=true" >> $GITHUB_OUTPUT
            echo "client-needs-deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸ¯ æ‰‹å‹•æŒ‡å®šéƒ¨ç½² Both (API + Client)"
            exit 0
          fi
          
          # ğŸ¤– auto æ¨¡å¼ï¼šæ ¹æ“šæª”æ¡ˆè®Šæ›´æ™ºèƒ½æ±ºå®šéƒ¨ç½²ç›®æ¨™
          echo "ğŸ¤– è‡ªå‹•æ¨¡å¼ï¼šæ ¹æ“šæª”æ¡ˆè®Šæ›´æ™ºèƒ½æ±ºå®šéƒ¨ç½²ç›®æ¨™"

          # ğŸ” æª¢æ¸¬è‡ªå‹•æ¨é€æ™‚çš„æ–‡ä»¶è®Šæ›´ï¼ˆè™•ç†é‚Šç•Œæƒ…æ³ï¼‰
          echo "ğŸ” æª¢æ¸¬æª”æ¡ˆè®Šæ›´..."
          
          # æª¢æŸ¥æ˜¯å¦æ˜¯åˆå§‹æäº¤æˆ–å–®ä¸€æäº¤çš„æƒ…æ³
          if ! git rev-parse HEAD~1 >/dev/null 2>&1; then
            echo "âš ï¸ åµæ¸¬åˆ°åˆå§‹æäº¤æˆ–å–®ä¸€æäº¤ï¼Œå‡è¨­æ‰€æœ‰æª”æ¡ˆéƒ½æœ‰è®Šæ›´"
            API_CHANGED=true
            CLIENT_CHANGED=true
            echo "ğŸ“¦ åˆå§‹éƒ¨ç½² - API å’Œ Client éƒ½éœ€è¦éƒ¨ç½²"
          else
            # æ­£å¸¸çš„è®Šæ›´æª¢æ¸¬
            if git diff --name-only HEAD~1 HEAD | grep -q "^inventory-api/"; then
              API_CHANGED=true
              echo "ğŸ“¦ æª¢æ¸¬åˆ° API è®Šæ›´"
            else
              echo "âœ… API ç„¡è®Šæ›´"
            fi

            if git diff --name-only HEAD~1 HEAD | grep -q "^inventory-client/"; then
              CLIENT_CHANGED=true
              echo "ğŸ“¦ æª¢æ¸¬åˆ° Client è®Šæ›´"
            else
              echo "âœ… Client ç„¡è®Šæ›´"
            fi
          fi

          # ğŸ”— ä¾è³´é‚è¼¯ï¼šå¦‚æœ API æœ‰è®Šæ›´ï¼ŒClient ä¹Ÿéœ€è¦é‡æ–°éƒ¨ç½²ï¼ˆåŒæ­¥ openapi.yamlï¼‰
          CLIENT_NEEDS_DEPLOY=false
          if [ "$API_CHANGED" = true ]; then
            CLIENT_NEEDS_DEPLOY=true
            if [ "$CLIENT_CHANGED" = true ]; then
              echo "ğŸ”— API + Client éƒ½æœ‰è®Šæ›´ -> å…¨é¢éƒ¨ç½²"
            else
              echo "ğŸ”— API è®Šæ›´detected -> Client éœ€è¦åŒæ­¥éƒ¨ç½² (openapi.yaml ä¾è³´)"
            fi
          elif [ "$CLIENT_CHANGED" = true ]; then
            CLIENT_NEEDS_DEPLOY=true
            echo "ğŸ¯ Client ç›´æ¥è®Šæ›´ -> Client éœ€è¦éƒ¨ç½²"
          fi

          # è¼¸å‡ºçµæœ
          echo "api=$API_CHANGED" >> $GITHUB_OUTPUT
          echo "client=$CLIENT_CHANGED" >> $GITHUB_OUTPUT
          echo "client-needs-deploy=$CLIENT_NEEDS_DEPLOY" >> $GITHUB_OUTPUT
          
          # ç¸½çµè¼¸å‡º
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²æ±ºç­–ç¸½çµï¼š"
          echo "   API éƒ¨ç½²: $API_CHANGED"
          echo "   Client éƒ¨ç½²: $CLIENT_NEEDS_DEPLOY"
          if [ "$API_CHANGED" = true ] && [ "$CLIENT_CHANGED" = false ]; then
            echo "   åŸå› : API è®Šæ›´ -> Client åŒæ­¥ openapi.yaml"
          elif [ "$API_CHANGED" = false ] && [ "$CLIENT_CHANGED" = true ]; then
            echo "   åŸå› : Client ç›´æ¥è®Šæ›´"
          elif [ "$API_CHANGED" = true ] && [ "$CLIENT_CHANGED" = true ]; then
            echo "   åŸå› : API å’Œ Client éƒ½æœ‰è®Šæ›´"
          elif [ "$API_CHANGED" = false ] && [ "$CLIENT_CHANGED" = false ]; then
            echo "   åŸå› : ç„¡è®Šæ›´ - å¯èƒ½æ˜¯æ‰‹å‹•è§¸ç™¼æˆ– force deploy"
          fi

  deploy-api:
    name: 'Deploy API to Cloud Run'
    runs-on: ubuntu-latest
    needs: detect-changes
    # ğŸ” åªæœ‰ç•¶ API éœ€è¦éƒ¨ç½²æ™‚æ‰åŸ·è¡Œ
    if: needs.detect-changes.outputs.api-changed == 'true'
    
    permissions:
      contents: 'read'
      id-token: 'write'

    defaults:
      run:
        working-directory: ./inventory-api

    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: 'access_token'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Setup PHP with Composer'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: gd, zip, pcntl, bcmath, xml, pdo_sqlite
          coverage: none

      - name: 'Cache Composer dependencies'
        uses: actions/cache@v4
        with:
          path: |
            inventory-api/vendor
            ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('inventory-api/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: 'Install Composer Dependencies (for Scribe only)'
        run: composer install --prefer-dist --no-progress --optimize-autoloader

      - name: 'Cache OpenAPI Generation'
        id: cache-openapi
        uses: actions/cache@v4
        with:
          path: inventory-api/storage/app/scribe/openapi.yaml
          key: ${{ runner.os }}-openapi-${{ hashFiles('inventory-api/app/Http/**/*.php', 'inventory-api/routes/**/*.php') }}
          restore-keys: |
            ${{ runner.os }}-openapi-

      - name: 'Generate OpenAPI Specification'
        if: steps.cache-openapi.outputs.cache-hit != 'true'
        run: |
          echo "APP_ENV=testing" > .env.testing
          echo "APP_KEY=base64:some_random_key_for_testing" >> .env.testing
          echo "DB_CONNECTION=sqlite" >> .env.testing
          echo "DB_DATABASE=database/testing.sqlite" >> .env.testing
          echo "CACHE_STORE=array" >> .env.testing
          echo "QUEUE_CONNECTION=sync" >> .env.testing
          echo "SESSION_DRIVER=array" >> .env.testing
          echo "DB_CACHE_CONNECTION=sqlite" >> .env.testing

          touch database/testing.sqlite
          php artisan migrate:fresh --force --env=testing
          php artisan scribe:generate --verbose --env=testing

      # ğŸš€ Docker æ§‹å»ºå„ªåŒ– - ä½¿ç”¨å¤šå±¤ç·©å­˜
      - name: 'Set up Docker Buildx'
        uses: docker/setup-buildx-action@v3

      - name: 'Create Artifact Repository (if not exists)'
        run: |
          # ä¸»è¦æ˜ åƒå„²å­˜åº«
          gcloud artifacts repositories create ${{ env.API_SERVICE_NAME }}-repo \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="API Docker repository" || echo "âœ… Main repo already exists"

      - name: 'Configure Docker for Artifact Registry'
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: 'Build and Push API Docker Image (Super Optimized)'
        uses: docker/build-push-action@v5
        with:
          context: ./inventory-api
          push: true
          tags: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.API_SERVICE_NAME }}-repo/api:latest
          # ğŸš€ è¶…ç´šå¿«å–ç­–ç•¥ï¼šGHA + Registry + Inline
          cache-from: |
            type=gha
            type=registry,ref=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.API_SERVICE_NAME }}-repo/cache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.API_SERVICE_NAME }}-repo/cache,mode=max
          platforms: linux/amd64
          # ğŸ”§ å»ºç½®å„ªåŒ–åƒæ•¸
          build-args: |
            BUILDKIT_INLINE_CACHE=1
          # ğŸ¯ å¤šæ ¸å¿ƒä¸¦è¡Œå»ºç½®
          outputs: type=image,compression=gzip,compression-level=6

      - name: 'Deploy API to Cloud Run (å›ºå®šåŸŸåç‰ˆæœ¬)'
        run: |-
          gcloud run deploy ${{ env.API_SERVICE_NAME }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.API_SERVICE_NAME }}-repo/api:latest \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --add-cloudsql-instances=${{ env.CLOUD_SQL_CONNECTION_NAME }} \
            --add-volume=name=gcs-storage,type=cloud-storage,bucket=${{ env.GCS_BUCKET }} \
            --add-volume-mount=volume=gcs-storage,mount-path=/mnt/gcs \
            --set-env-vars="APP_ENV=production,APP_NAME=åº«å­˜ç®¡ç†ç³»çµ±,APP_DEBUG=false,APP_TIMEZONE=Asia/Taipei,APP_LOCALE=zh_TW,APP_FALLBACK_LOCALE=zh_TW,BCRYPT_ROUNDS=12,APP_MAINTENANCE_DRIVER=file,DB_CONNECTION=mysql,DB_SOCKET=/cloudsql/${{ env.CLOUD_SQL_CONNECTION_NAME }},DB_PORT=3306,DB_DATABASE=lomis_internal,DB_USERNAME=h1431532403240,SESSION_DOMAIN=.lomis.com.tw,SESSION_DRIVER=file,SESSION_LIFETIME=120,SESSION_ENCRYPT=false,SESSION_PATH=/,FILESYSTEM_DISK=gcs,GCS_BUCKET=${{ env.GCS_BUCKET }},GOOGLE_CLOUD_PROJECT_ID=${{ env.PROJECT_ID }},CACHE_STORE=file,QUEUE_CONNECTION=sync,BROADCAST_CONNECTION=log,LOG_CHANNEL=stack,LOG_LEVEL=error,SPATIE_PERMISSION_CACHE_EXPIRATION_TIME=3600,GCS_MOUNT_PATH=/mnt/gcs,FRONTEND_URL=${{ secrets.CLIENT_CUSTOM_DOMAIN_URL }},SANCTUM_STATEFUL_DOMAINS=$(echo '${{ secrets.CLIENT_CUSTOM_DOMAIN_URL }}' | sed 's|https://||' | sed 's|/.*||')" \
            --set-secrets="APP_KEY=LARAVEL_APP_KEY:latest,DB_PASSWORD=LARAVEL_DB_PASSWORD:latest" \
            --timeout=300 \
            --memory=1Gi \
            --cpu=2 \
            --concurrency=80 \
            --min-instances=0 \
            --max-instances=5
        working-directory: . # æ­¤æ­¥é©Ÿåœ¨æ ¹ç›®éŒ„åŸ·è¡Œ

      # è¨»è§£ï¼šå‹•æ…‹åŸŸåç²å–ï¼ˆä¿ç•™ä»¥å‚™å°‡ä¾†ä½¿ç”¨ï¼‰
      # - name: 'Get Deployed URLs (å‹•æ…‹åŸŸå - å·²åœç”¨)'
      #   id: get_urls
      #   run: |-
      #     # ç²å– API æœå‹™çš„å¯¦éš› URL
      #     API_URL=$(gcloud run services describe ${{ env.API_SERVICE_NAME }} --platform=managed --region=${{ env.REGION }} --format='value(status.url)')
      #     echo "API_URL=$API_URL" >> $GITHUB_OUTPUT
      #     
      #     # å˜—è©¦ç²å–å‰ç«¯æœå‹™ URLï¼ˆå¦‚æœå·²å­˜åœ¨ï¼‰
      #     CLIENT_URL=$(gcloud run services describe ${{ env.CLIENT_SERVICE_NAME }} --platform=managed --region=${{ env.REGION }} --format='value(status.url)' 2>/dev/null || echo "")
      #     
      #     if [ -z "$CLIENT_URL" ]; then
      #       # å¦‚æœå‰ç«¯é‚„æœªéƒ¨ç½²ï¼Œä½¿ç”¨ API URL çš„ç›¸åŒæ¨¡å¼
      #       CLIENT_BASE=$(echo $API_URL | sed 's/inventory-api/inventory-client/')
      #       echo "CLIENT_URL=$CLIENT_BASE" >> $GITHUB_OUTPUT
      #     else
      #       echo "CLIENT_URL=$CLIENT_URL" >> $GITHUB_OUTPUT
      #     fi
      #     
      #     # æå–åŸŸåç”¨æ–¼ SANCTUMï¼ˆåªä½¿ç”¨å‰ç«¯åŸŸåï¼‰
      #     CLIENT_DOMAIN=$(echo ${CLIENT_URL:-$CLIENT_BASE} | sed 's|https://||' | sed 's|/.*||')
      #     echo "SANCTUM_DOMAINS=$CLIENT_DOMAIN" >> $GITHUB_OUTPUT
      #     
      #     echo "API URL: $API_URL"
      #     echo "é æœŸçš„å‰ç«¯ URL: ${CLIENT_URL:-$CLIENT_BASE}"
      #   working-directory: . # æ­¤æ­¥é©Ÿåœ¨æ ¹ç›®éŒ„åŸ·è¡Œ

      - name: 'Run Database Migrations'
        run: |-
          gcloud run jobs create ${{ env.API_SERVICE_NAME }}-migrate \
            --region=${{ env.REGION }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.API_SERVICE_NAME }}-repo/api:latest \
            --task-timeout=300 \
            --memory=512Mi \
            --cpu=1 \
            --command=/usr/local/bin/run-artisan.sh \
            --args=migrate,--force \
            --set-cloudsql-instances=${{ env.CLOUD_SQL_CONNECTION_NAME }} \
            --set-env-vars="APP_ENV=production,DB_CONNECTION=mysql,DB_SOCKET=/cloudsql/${{ env.CLOUD_SQL_CONNECTION_NAME }},DB_PORT=3306,DB_DATABASE=lomis_internal,DB_USERNAME=h1431532403240" \
            --set-secrets="APP_KEY=LARAVEL_APP_KEY:latest,DB_PASSWORD=LARAVEL_DB_PASSWORD:latest" \
            --execute-now || \
          gcloud run jobs execute ${{ env.API_SERVICE_NAME }}-migrate \
            --region=${{ env.REGION }} \
            --wait
        working-directory: . # æ­¤æ­¥é©Ÿåœ¨æ ¹ç›®éŒ„åŸ·è¡Œ

      - name: 'Run Initial Admin Seeder'
        run: |-
          gcloud run jobs create ${{ env.API_SERVICE_NAME }}-seed-admin \
            --region=${{ env.REGION }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.API_SERVICE_NAME }}-repo/api:latest \
            --task-timeout=300 \
            --memory=512Mi \
            --cpu=1 \
            --command=/usr/local/bin/run-artisan.sh \
            --args=db:seed,--class=InitialAdminSeeder,--force \
            --set-cloudsql-instances=${{ env.CLOUD_SQL_CONNECTION_NAME }} \
            --set-env-vars="APP_ENV=production,DB_CONNECTION=mysql,DB_SOCKET=/cloudsql/${{ env.CLOUD_SQL_CONNECTION_NAME }},DB_PORT=3306,DB_DATABASE=lomis_internal,DB_USERNAME=h1431532403240" \
            --set-secrets="APP_KEY=LARAVEL_APP_KEY:latest,DB_PASSWORD=LARAVEL_DB_PASSWORD:latest" \
            --execute-now || \
          gcloud run jobs execute ${{ env.API_SERVICE_NAME }}-seed-admin \
            --region=${{ env.REGION }} \
            --wait
        working-directory: . # æ­¤æ­¥é©Ÿåœ¨æ ¹ç›®éŒ„åŸ·è¡Œ

      # ğŸ”¥ é—œéµï¼šåªæœ‰ç•¶æ‰€æœ‰ API éƒ¨ç½²æ­¥é©Ÿéƒ½æˆåŠŸå¾Œï¼Œæ‰è™•ç† OpenAPI
      - name: 'Final OpenAPI Validation Before Cache'
        run: |
          echo "ğŸ” API éƒ¨ç½²å®Œå…¨æˆåŠŸï¼Œæº–å‚™ç·©å­˜ OpenAPI è¦æ ¼"
          
          # ğŸ¯ ä¿®å¾©è·¯å¾‘å•é¡Œï¼šæª¢æŸ¥æ­£ç¢ºçš„ OpenAPI æª”æ¡ˆä½ç½®
          OPENAPI_SOURCE="storage/app/scribe/openapi.yaml"
          OPENAPI_TARGET="openapi.yaml"
          
          if [ ! -f "$OPENAPI_SOURCE" ] || [ ! -s "$OPENAPI_SOURCE" ]; then
            echo "âŒ OpenAPI æºæª”æ¡ˆä¸å­˜åœ¨æˆ–ç‚ºç©º: $OPENAPI_SOURCE"
            echo "ğŸ” æª¢æŸ¥ storage/app/scribe/ ç›®éŒ„å…§å®¹ï¼š"
            ls -la storage/app/scribe/ || echo "ç›®éŒ„ä¸å­˜åœ¨"
            exit 1
          fi
          
          # è¤‡è£½åˆ°æ ¹ç›®éŒ„ä»¥ä¾¿ cacheï¼ˆä¿æŒ artifact å’Œ cache çš„ä¸€è‡´æ€§ï¼‰
          cp "$OPENAPI_SOURCE" "$OPENAPI_TARGET"
          echo "âœ… å·²è¤‡è£½ OpenAPI æª”æ¡ˆï¼š$OPENAPI_SOURCE â†’ $OPENAPI_TARGET"
          
          if ! grep -q "openapi:" "$OPENAPI_TARGET"; then
            echo "âŒ OpenAPI æª”æ¡ˆæ ¼å¼ç„¡æ•ˆï¼Œè·³é cache"
            echo "ğŸ” æª”æ¡ˆå…§å®¹é è¦½ï¼š"
            head -10 "$OPENAPI_TARGET"
            exit 1
          fi
          
          ENDPOINTS=$(grep -c "operationId:" "$OPENAPI_TARGET" || echo "0")
          FINAL_SIZE=$(wc -c < "$OPENAPI_TARGET")
          FINAL_LINES=$(wc -l < "$OPENAPI_TARGET")
          
          echo "ğŸ“Š OpenAPI æª”æ¡ˆé©—è­‰ï¼š"
          echo "   æª”æ¡ˆå¤§å°: $FINAL_SIZE bytes"
          echo "   æª”æ¡ˆè¡Œæ•¸: $FINAL_LINES lines"
          echo "   API ç«¯é»æ•¸é‡: $ENDPOINTS"
          
          if [ "$ENDPOINTS" -lt 5 ]; then
            echo "âš ï¸ OpenAPI ç«¯é»æ•¸é‡éå°‘ ($ENDPOINTS)ï¼Œå¯èƒ½æœ‰å•é¡Œ"
            echo "ğŸ” æª”æ¡ˆå…§å®¹é è¦½ï¼š"
            head -20 "$OPENAPI_TARGET"
          fi
          
          echo "âœ… OpenAPI æª”æ¡ˆé©—è­‰é€šéï¼Œæº–å‚™ä¸Šå‚³å’Œç·©å­˜"
        working-directory: ./inventory-api
        if: success()

      - name: 'Upload OpenAPI as Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: inventory-api/openapi.yaml
        if: success()

      - name: 'Cache OpenAPI for Frontend (Final Step)'
        uses: actions/cache@v4
        with:
          path: inventory-api/openapi.yaml
          key: openapi-latest
        if: success()

      - name: 'Confirm OpenAPI Cache Success'
        run: |
          echo "âœ… å¾Œç«¯éƒ¨ç½²å®Œå…¨æˆåŠŸ"
          echo "ğŸ“¦ OpenAPI è¦æ ¼å·²ç·©å­˜ï¼Œå°æ‡‰æˆåŠŸéƒ¨ç½²çš„å¾Œç«¯ç‰ˆæœ¬"
          echo "ğŸ¯ å‰ç«¯éƒ¨ç½²æ™‚å°‡ä½¿ç”¨æ­¤è¦æ ¼"
          echo "ğŸ”‘ Cache Key: openapi-latest"
        if: success()

  deploy-client:
    name: 'Deploy Client to Cloud Run'
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-api]
    # ğŸ” Client ä¾è³´æª¢æ¸¬ + API ä¾è³´æª¢æŸ¥
    if: |
      always() && 
      needs.detect-changes.outputs.client-needs-deploy == 'true' &&
      (needs.deploy-api.result == 'success' || needs.deploy-api.result == 'skipped')

    permissions:
      contents: 'read'
      id-token: 'write'

    defaults:
      run:
        working-directory: ./inventory-client

    steps:
      - name: 'Deployment Reason Analysis'
        run: |
          echo "ğŸ” å‰ç«¯éƒ¨ç½²åŸå› åˆ†æï¼š"
          
          # å®‰å…¨åœ°è™•ç† GitHub Actions è¼¸å‡ºè®Šæ•¸
          API_CHANGED="${{ needs.detect-changes.outputs.api-changed || 'false' }}"
          CLIENT_CHANGED="${{ needs.detect-changes.outputs.client-changed || 'false' }}"
          DEPLOY_TARGET="${{ needs.detect-changes.outputs.deploy-target || 'auto' }}"
          
          echo "   è®Šæ•¸ç‹€æ…‹æª¢æŸ¥ï¼š"
          echo "     API_CHANGED: '${API_CHANGED}'"
          echo "     CLIENT_CHANGED: '${CLIENT_CHANGED}'" 
          echo "     DEPLOY_TARGET: '${DEPLOY_TARGET}'"
          echo ""
          
          # æ¨™æº–åŒ–è®Šæ•¸å€¼ï¼Œé¿å…ç©ºå€¼å•é¡Œ
          [ -z "$API_CHANGED" ] && API_CHANGED="false"
          [ -z "$CLIENT_CHANGED" ] && CLIENT_CHANGED="false" 
          [ -z "$DEPLOY_TARGET" ] && DEPLOY_TARGET="auto"
          
          echo "   æ¨™æº–åŒ–å¾Œï¼š"
          echo "     API_CHANGED: '${API_CHANGED}'"
          echo "     CLIENT_CHANGED: '${CLIENT_CHANGED}'"
          echo "     DEPLOY_TARGET: '${DEPLOY_TARGET}'"
          echo ""
          
          if [ "${DEPLOY_TARGET}" = "both" ] || [ "${DEPLOY_TARGET}" = "client" ]; then
            echo "   ğŸ“‹ æ‰‹å‹•æŒ‡å®šéƒ¨ç½²ç›®æ¨™: ${DEPLOY_TARGET}"
          elif [ "${API_CHANGED}" = "true" ] && [ "${CLIENT_CHANGED}" = "false" ]; then
            echo "   ğŸ”— API è®Šæ›´ä¾è³´éƒ¨ç½² - åŒæ­¥æœ€æ–° openapi.yaml"
            echo "   ğŸ“¦ API æœ‰è®Šæ›´ï¼Œå‰ç«¯éœ€è¦æ›´æ–°é¡å‹å®šç¾©"
          elif [ "${API_CHANGED}" = "false" ] && [ "${CLIENT_CHANGED}" = "true" ]; then
            echo "   ğŸ¯ å‰ç«¯ç›´æ¥è®Šæ›´éƒ¨ç½²"
            echo "   ğŸ“¦ å‰ç«¯ä»£ç¢¼æœ‰è®Šæ›´"
          elif [ "${API_CHANGED}" = "true" ] && [ "${CLIENT_CHANGED}" = "true" ]; then
            echo "   ğŸ”„ API å’Œå‰ç«¯éƒ½æœ‰è®Šæ›´"
            echo "   ğŸ“¦ å…¨é¢åŒæ­¥éƒ¨ç½²"
          else
            echo "   â“ æœªé æœŸçš„éƒ¨ç½²ç‹€æ³"
            echo "   é€™å¯èƒ½æ˜¯ auto æ¨¡å¼çš„æ™ºèƒ½æª¢æ¸¬çµæœ"
            echo "   è©³ç´°: API=${API_CHANGED}, CLIENT=${CLIENT_CHANGED}, TARGET=${DEPLOY_TARGET}"
          fi
          echo ""
        working-directory: . # ğŸ”§ åœ¨æ ¹ç›®éŒ„åŸ·è¡Œï¼Œå› ç‚ºæ­¤æ™‚ inventory-client ç›®éŒ„é‚„ä¸å­˜åœ¨

      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: 'access_token'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Restore Latest OpenAPI from Cache'
        uses: actions/cache@v4
        with:
          path: inventory-api/openapi.yaml
          key: openapi-latest
        continue-on-error: true

      - name: 'Download OpenAPI Artifact'
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: ./artifact-temp
        continue-on-error: true

      - name: 'Smart OpenAPI Acquisition Strategy'
        run: |
          # å®‰å…¨åœ°è™•ç† GitHub Actions è¼¸å‡ºè®Šæ•¸
          API_CHANGED="${{ needs.detect-changes.outputs.api-changed || 'false' }}"
          CLIENT_CHANGED="${{ needs.detect-changes.outputs.client-changed || 'false' }}"
          DEPLOY_API_RESULT="${{ needs.deploy-api.result || 'skipped' }}"
          DEPLOY_TARGET="${{ needs.detect-changes.outputs.deploy-target || 'auto' }}"
          
          # æ¨™æº–åŒ–è®Šæ•¸å€¼
          [ -z "$API_CHANGED" ] && API_CHANGED="false"
          [ -z "$CLIENT_CHANGED" ] && CLIENT_CHANGED="false"
          [ -z "$DEPLOY_API_RESULT" ] && DEPLOY_API_RESULT="skipped"
          [ -z "$DEPLOY_TARGET" ] && DEPLOY_TARGET="auto"
          
          echo "ğŸ” æ™ºèƒ½ OpenAPI ç²å–ç­–ç•¥ï¼ˆCache å„ªå…ˆï¼‰ï¼š"
          echo "   API è®Šæ›´: $API_CHANGED"
          echo "   Client è®Šæ›´: $CLIENT_CHANGED"
          echo "   API éƒ¨ç½²çµæœ: $DEPLOY_API_RESULT"
          echo "   éƒ¨ç½²ç›®æ¨™: $DEPLOY_TARGET"
          echo ""
          
          # ğŸ¯ ç­–ç•¥ 1: æª¢æŸ¥ cache çµæœï¼ˆæœ€é«˜å„ªå…ˆç´šï¼‰
          if [ -f ../inventory-api/openapi.yaml ] && [ -s ../inventory-api/openapi.yaml ] && grep -q "openapi:" ../inventory-api/openapi.yaml; then
            echo "âœ… ç­–ç•¥ 1 æˆåŠŸï¼šä½¿ç”¨ Cache ä¸­çš„ OpenAPI è¦æ ¼"
            OPENAPI_SIZE=$(wc -c < ../inventory-api/openapi.yaml)
            OPENAPI_LINES=$(wc -l < ../inventory-api/openapi.yaml)
            echo "   æª”æ¡ˆå¤§å°: $OPENAPI_SIZE bytes, è¡Œæ•¸: $OPENAPI_LINES"
            echo "ğŸ“¦ ä¾†æºï¼šæœ€å¾Œä¸€æ¬¡æˆåŠŸ API éƒ¨ç½²çš„è¦æ ¼ï¼ˆCacheï¼‰"
            
            # è¤‡è£½åˆ°ç•¶å‰å·¥ä½œç›®éŒ„
            cp ../inventory-api/openapi.yaml ./openapi.yaml
          else
            echo "âŒ ç­–ç•¥ 1 å¤±æ•—ï¼šCache ä¸­ç„¡å¯ç”¨ OpenAPI è¦æ ¼"
            
            # ğŸ¯ ç­–ç•¥ 2: æª¢æŸ¥ artifact ä¸‹è¼‰çµæœ
            if [ -f ../artifact-temp/openapi.yaml ] && [ -s ../artifact-temp/openapi.yaml ] && grep -q "openapi:" ../artifact-temp/openapi.yaml; then
              echo "âœ… ç­–ç•¥ 2 æˆåŠŸï¼šä½¿ç”¨ Artifact ä¸­çš„ OpenAPI è¦æ ¼"
              OPENAPI_SIZE=$(wc -c < ../artifact-temp/openapi.yaml)
              OPENAPI_LINES=$(wc -l < ../artifact-temp/openapi.yaml)
              echo "   æª”æ¡ˆå¤§å°: $OPENAPI_SIZE bytes, è¡Œæ•¸: $OPENAPI_LINES"
              
              # è¤‡è£½åˆ°ç•¶å‰å·¥ä½œç›®éŒ„
              cp ../artifact-temp/openapi.yaml ./openapi.yaml
              
              if [ "$API_CHANGED" = "true" ]; then
                echo "ğŸ”„ ä¾†æºï¼šæœ€æ–°ç”Ÿæˆçš„ API è¦æ ¼ï¼ˆAPI æœ‰è®Šæ›´ï¼‰"
              else
                echo "ğŸ“‹ ä¾†æºï¼šç•¶æ¬¡éƒ¨ç½²ç”Ÿæˆçš„ API è¦æ ¼"
              fi
            else
              echo "âŒ ç­–ç•¥ 2 å¤±æ•—ï¼šartifact ä¸å¯ç”¨æˆ–å…§å®¹ç„¡æ•ˆ"
              
              # æª¢æŸ¥ artifact ç›®éŒ„å…§å®¹ä»¥ä¾¿èª¿è©¦
              echo "ğŸ” æª¢æŸ¥ artifact ç›®éŒ„å…§å®¹ï¼š"
              ls -la ../artifact-temp/ || echo "artifact-temp ç›®éŒ„ä¸å­˜åœ¨"
              
              rm -f ./openapi.yaml
              
              # ğŸ”§ ç­–ç•¥ 3: å‰µå»ºå¢å¼·ç‰ˆ fallback ï¼ˆæœ€å¾Œæ‰‹æ®µï¼‰
              echo ""
              echo "ğŸ”§ ç­–ç•¥ 3ï¼šå‰µå»ºå¢å¼·ç‰ˆ fallback OpenAPI è¦æ ¼"
              echo "   âš ï¸ é€™æ˜¯æœ€å¾Œæ‰‹æ®µï¼Œå¯èƒ½å°è‡´å‰ç«¯é¡å‹å®šç¾©ä¸å®Œæ•´"
              
              cat > ./openapi.yaml << 'EOF'
          openapi: 3.0.0
          info:
            title: Inventory Management API
            version: 1.0.0
            description: 'Enhanced fallback API specification for client build'
            contact:
              name: Inventory System
          servers:
            - url: '${{ secrets.API_CUSTOM_DOMAIN_URL }}'
              description: Production API server
          paths:
            /api/health:
              get:
                summary: Health check endpoint
                operationId: healthCheck
                tags: [System]
                responses:
                  '200':
                    description: API is healthy
                    content:
                      application/json:
                        schema:
                          type: object
                          properties:
                            status:
                              type: string
                              example: ok
            /api/login:
              post:
                summary: User login
                operationId: login
                tags: [Authentication]
                requestBody:
                  required: true
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          username:
                            type: string
                          password:
                            type: string
                responses:
                  '200':
                    description: Login successful
                    content:
                      application/json:
                        schema:
                          type: object
                          properties:
                            user:
                              $ref: '#/components/schemas/User'
                            token:
                              type: string
                  '401':
                    description: Invalid credentials
                    content:
                      application/json:
                        schema:
                          $ref: '#/components/schemas/Error'
            /api/user:
              get:
                summary: Get current user
                operationId: getCurrentUser
                tags: [User]
                security:
                  - bearerAuth: []
                responses:
                  '200':
                    description: Current user information
                    content:
                      application/json:
                        schema:
                          $ref: '#/components/schemas/User'
          components:
            securitySchemes:
              bearerAuth:
                type: http
                scheme: bearer
                bearerFormat: JWT
            schemas:
              User:
                type: object
                properties:
                  id:
                    type: integer
                  name:
                    type: string
                  username:
                    type: string
                  email:
                    type: string
                    format: email
                  is_admin:
                    type: boolean
                  roles:
                    type: array
                    items:
                      type: string
                  roles_display:
                    type: array
                    items:
                      type: string
              Error:
                type: object
                properties:
                  message:
                    type: string
                  code:
                    type: integer
                  errors:
                    type: object
              PaginatedResponse:
                type: object
                properties:
                  data:
                    type: array
                    items: {}
                  meta:
                    type: object
                    properties:
                      current_page:
                        type: integer
                      last_page:
                        type: integer
                      per_page:
                        type: integer
                      total:
                        type: integer
          EOF
            
              echo "ğŸ“„ å·²å‰µå»ºå¢å¼·ç‰ˆ fallback OpenAPI è¦æ ¼"
              echo "   åŒ…å«ï¼šèªè­‰ç«¯é»ã€ç”¨æˆ¶ç®¡ç†ã€åŸºæœ¬è³‡æ–™çµæ§‹"
              echo "   âš ï¸ ä»å»ºè­°åœ¨ä¸‹æ¬¡éƒ¨ç½²æ™‚åŒæ™‚æ›´æ–° API ä»¥ç²å–å®Œæ•´è¦æ ¼"
            fi
          fi
          
          # æœ€çµ‚æª”æ¡ˆç‹€æ…‹å ±å‘Š
          echo ""
          echo "ğŸ“‹ æœ€çµ‚ OpenAPI æª”æ¡ˆç‹€æ…‹ï¼š"
          if [ -f ./openapi.yaml ]; then
            ls -la ./openapi.yaml
            FINAL_SIZE=$(wc -c < ./openapi.yaml)
            FINAL_LINES=$(wc -l < ./openapi.yaml)
          else
            echo "âŒ æ‰¾ä¸åˆ° OpenAPI æª”æ¡ˆ"
            exit 1
          fi
          
          echo "æª”æ¡ˆå¤§å°: $FINAL_SIZE bytes"
          echo "æª”æ¡ˆè¡Œæ•¸: $FINAL_LINES lines"
          
          # å“è³ªæª¢æŸ¥
          ENDPOINTS=$(grep -c "operationId:" ./openapi.yaml || echo "0")
          SCHEMAS=$(grep -c "schemas:" ./openapi.yaml || echo "0")
          echo "API ç«¯é»æ•¸é‡: $ENDPOINTS"
          echo "Schema å®šç¾©: $SCHEMAS å€‹å€å¡Š"
          
          if [ "$ENDPOINTS" -gt 10 ]; then
            echo "âœ… OpenAPI è¦æ ¼å®Œæ•´åº¦ï¼šå„ªç§€ ($ENDPOINTS å€‹ç«¯é»)"
          elif [ "$ENDPOINTS" -gt 5 ]; then
            echo "âœ… OpenAPI è¦æ ¼å®Œæ•´åº¦ï¼šè‰¯å¥½ ($ENDPOINTS å€‹ç«¯é»)"
          elif [ "$ENDPOINTS" -gt 0 ]; then
            echo "âš ï¸ OpenAPI è¦æ ¼å®Œæ•´åº¦ï¼šåŸºæœ¬ ($ENDPOINTS å€‹ç«¯é»ï¼Œå¯èƒ½å½±éŸ¿é¡å‹ç”Ÿæˆ)"
          else
            echo "âŒ OpenAPI è¦æ ¼å®Œæ•´åº¦ï¼šä¸è¶³ï¼Œå‰ç«¯ç·¨è­¯å¯èƒ½å¤±æ•—"
            exit 1
          fi

      # ğŸš€ Node.js ç·©å­˜å„ªåŒ–
      - name: 'Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # æ›´æ–°åˆ°æ›´ç©©å®šçš„ç‰ˆæœ¬
          cache: 'npm'
          cache-dependency-path: inventory-client/package-lock.json

      - name: 'Install Dependencies'
        run: |
          echo "ğŸ” å®‰è£ä¾è³´å‰çš„ç’°å¢ƒæª¢æŸ¥ï¼š"
          echo "Node.js ç‰ˆæœ¬: $(node --version)"
          echo "npm ç‰ˆæœ¬: $(npm --version)"
          echo "ç•¶å‰ç›®éŒ„: $(pwd)"
          echo "package.json æª¢æŸ¥ï¼š"
          ls -la package.json
          
          npm ci --verbose
          
          echo "âœ… ä¾è³´å®‰è£å®Œæˆ"
          echo "node_modules å¤§å°: $(du -sh node_modules)"
        working-directory: ./inventory-client

      - name: 'Generate API Types'
        run: |
          echo "ğŸ” ç”Ÿæˆ API é¡å‹å®šç¾©ï¼š"
          echo "OpenAPI æª”æ¡ˆæª¢æŸ¥ï¼š"
          ls -la openapi.yaml
          
          # ç¢ºä¿ openapi.yaml æª”æ¡ˆå­˜åœ¨ä¸¦æœ‰æ•ˆ
          if ! grep -q "openapi:" openapi.yaml; then
            echo "âŒ OpenAPI æª”æ¡ˆæ ¼å¼ç„¡æ•ˆ"
            head -10 openapi.yaml
            exit 1
          fi
          
          npm run api:types
          
          echo "âœ… API é¡å‹å®šç¾©ç”Ÿæˆå®Œæˆ"
          echo "ç”Ÿæˆçš„é¡å‹æª”æ¡ˆæª¢æŸ¥ï¼š"
          ls -la src/types/api.ts
        working-directory: ./inventory-client
        
      - name: 'Build Application with Enhanced Logging'
        run: |
          echo "ğŸš€ é–‹å§‹æ§‹å»ºæ‡‰ç”¨ï¼š"
          echo "æ§‹å»ºå‰ç’°å¢ƒæª¢æŸ¥ï¼š"
          echo "è¨˜æ†¶é«”ä½¿ç”¨: $(free -h || echo 'N/A')"
          echo "ç£ç¢Ÿç©ºé–“: $(df -h . || echo 'N/A')"
          
          # è¨­ç½®æ›´è©³ç´°çš„ Next.js æ§‹å»ºæ—¥èªŒ
          export DEBUG=1
          export NODE_OPTIONS="--max-old-space-size=4096"
          
          npm run build
        working-directory: ./inventory-client

      # ğŸš€ Docker æ§‹å»ºå„ªåŒ– - ä½¿ç”¨å¤šå±¤ç·©å­˜
      - name: 'Set up Docker Buildx'
        uses: docker/setup-buildx-action@v3

      - name: 'Create Artifact Repository (if not exists)'
        run: |
          gcloud artifacts repositories create ${{ env.CLIENT_SERVICE_NAME }}-repo \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="Client Docker repository" || echo "âœ… Repo already exists"
        working-directory: ..

      - name: 'Configure Docker for Artifact Registry'
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: 'Build and Push Client Docker Image (Optimized)'
        uses: docker/build-push-action@v5
        with:
          context: ./inventory-client
          push: true
          tags: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.CLIENT_SERVICE_NAME }}-repo/client:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            NEXT_PUBLIC_API_BASE_URL=${{ secrets.API_CUSTOM_DOMAIN_URL }}

      - name: 'Deploy Client to Cloud Run (å›ºå®šåŸŸåç‰ˆæœ¬)'
        id: deploy_client
        run: |-
          gcloud run deploy ${{ env.CLIENT_SERVICE_NAME }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.CLIENT_SERVICE_NAME }}-repo/client:latest \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars="NEXT_PUBLIC_API_BASE_URL=${{ secrets.API_CUSTOM_DOMAIN_URL }},NEXTAUTH_URL=${{ secrets.CLIENT_CUSTOM_DOMAIN_URL }},AUTH_URL=${{ secrets.CLIENT_CUSTOM_DOMAIN_URL }},AUTH_TRUST_HOST=auto" \
            --set-secrets="NEXTAUTH_SECRET=NEXTAUTH_SECRET:latest" \
            --timeout=300 \
            --memory=512Mi \
            --cpu=1 \
            --concurrency=100 \
            --min-instances=0 \
            --max-instances=3
        working-directory: . # æ­¤æ­¥é©Ÿåœ¨æ ¹ç›®éŒ„åŸ·è¡Œ

      # è¨»è§£ï¼šå‹•æ…‹åŸŸåéƒ¨åˆ†ï¼ˆä¿ç•™ä»¥å‚™å°‡ä¾†ä½¿ç”¨ï¼‰
      # - name: 'Determine API URL (å‹•æ…‹ç‰ˆæœ¬ - å·²åœç”¨)'
      #   id: get_api_url
      #   run: |-
      #     # å„ªå…ˆä½¿ç”¨è‡ªè¨‚ç¶²åŸŸï¼ˆå¦‚æœæœ‰è¨­å®šï¼‰
      #     if [ ! -z "${{ secrets.API_CUSTOM_DOMAIN_URL }}" ]; then
      #       echo "API_URL=${{ secrets.API_CUSTOM_DOMAIN_URL }}" >> $GITHUB_OUTPUT
      #       echo "ä½¿ç”¨è‡ªè¨‚ç¶²åŸŸ: ${{ secrets.API_CUSTOM_DOMAIN_URL }}"
      #     else
      #       # ç²å–å¯¦éš›éƒ¨ç½²çš„ API URL
      #       API_URL=$(gcloud run services describe ${{ env.API_SERVICE_NAME }} --platform=managed --region=${{ env.REGION }} --format='value(status.url)')
      #       echo "API_URL=$API_URL" >> $GITHUB_OUTPUT
      #       echo "ä½¿ç”¨ Cloud Run URL: $API_URL"
      #     fi
      #   working-directory: . # æ­¤æ­¥é©Ÿåœ¨æ ¹ç›®éŒ„åŸ·è¡Œ

      - name: 'Display Deployment URLs'
        run: |-
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ğŸ“‹ æœ¬æ¬¡éƒ¨ç½²ç¸½çµï¼š"
          
          # å®‰å…¨åœ°è™•ç†è®Šæ•¸
          API_CHANGED="${{ needs.detect-changes.outputs.api-changed || 'false' }}"
          CLIENT_CHANGED="${{ needs.detect-changes.outputs.client-changed || 'false' }}"
          [ -z "$API_CHANGED" ] && API_CHANGED="false"
          [ -z "$CLIENT_CHANGED" ] && CLIENT_CHANGED="false"
          
          if [ "${API_CHANGED}" = "true" ] && [ "${CLIENT_CHANGED}" = "false" ]; then
            echo "   ğŸ”— API è®Šæ›´è§¸ç™¼çš„ä¾è³´éƒ¨ç½²"
            echo "   ğŸ“¦ API æœ‰æ›´æ–° â†’ å‰ç«¯åŒæ­¥æ–°çš„ API é¡å‹å®šç¾©"
          elif [ "${API_CHANGED}" = "false" ] && [ "${CLIENT_CHANGED}" = "true" ]; then
            echo "   ğŸ¯ å‰ç«¯ç¨ç«‹éƒ¨ç½²"
            echo "   ğŸ“¦ åªæœ‰å‰ç«¯ä»£ç¢¼è®Šæ›´"
          elif [ "${API_CHANGED}" = "true" ] && [ "${CLIENT_CHANGED}" = "true" ]; then
            echo "   ğŸ”„ å‰å¾Œç«¯å…¨é¢æ›´æ–°"
            echo "   ğŸ“¦ API å’Œå‰ç«¯éƒ½æœ‰è®Šæ›´"
          fi
          
          echo ""
          echo "ğŸŒ æœå‹™ç¶²å€ï¼š"
          echo "   API æœå‹™: ${{ secrets.API_CUSTOM_DOMAIN_URL }}"
          echo "   å‰ç«¯æœå‹™: ${{ secrets.CLIENT_CUSTOM_DOMAIN_URL }}"
          echo ""
          echo "ğŸ’¡ ä¾è³´é‚è¼¯èªªæ˜ï¼š"
          echo "   â€¢ API è®Šæ›´ â†’ å‰ç«¯è‡ªå‹•åŒæ­¥ (openapi.yaml ä¾è³´)"
          echo "   â€¢ å‰ç«¯è®Šæ›´ â†’ å‰ç«¯ç¨ç«‹éƒ¨ç½²"
          echo "   â€¢ ç„¡è®Šæ›´ â†’ è·³ééƒ¨ç½²ï¼ˆç¯€çœæ™‚é–“ï¼‰"
        working-directory: . # æ­¤æ­¥é©Ÿåœ¨æ ¹ç›®éŒ„åŸ·è¡Œ

  # ğŸ¯ éƒ¨ç½²ç¸½çµ
  deployment-summary:
    name: 'Deployment Summary'
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-api, deploy-client]
    if: always() && github.repository == 'lomismoney/Mir01'
    
    steps:
      - name: 'Complete Deployment Summary'
        run: |
          echo "ğŸ å®Œæ•´éƒ¨ç½²ç¸½çµå ±å‘Š"
          echo "======================"
          echo ""
          
          # å®‰å…¨åœ°å–å¾—æ‰€æœ‰ç›¸é—œè®Šæ•¸
          API_CHANGED="${{ needs.detect-changes.outputs.api-changed || 'false' }}"
          CLIENT_CHANGED="${{ needs.detect-changes.outputs.client-changed || 'false' }}"
          CLIENT_NEEDS_DEPLOY="${{ needs.detect-changes.outputs.client-needs-deploy || 'false' }}"
          FORCE_DEPLOY="${{ needs.detect-changes.outputs.force-deploy || 'false' }}"
          DEPLOY_TARGET="${{ needs.detect-changes.outputs.deploy-target || 'auto' }}"
          
          DETECT_RESULT="${{ needs.detect-changes.result || 'skipped' }}"
          API_RESULT="${{ needs.deploy-api.result || 'skipped' }}"
          CLIENT_RESULT="${{ needs.deploy-client.result || 'skipped' }}"
          
          # æ¨™æº–åŒ–è®Šæ•¸å€¼
          [ -z "$API_CHANGED" ] && API_CHANGED="false"
          [ -z "$CLIENT_CHANGED" ] && CLIENT_CHANGED="false"
          [ -z "$CLIENT_NEEDS_DEPLOY" ] && CLIENT_NEEDS_DEPLOY="false"
          [ -z "$FORCE_DEPLOY" ] && FORCE_DEPLOY="false"
          [ -z "$DEPLOY_TARGET" ] && DEPLOY_TARGET="auto"
          [ -z "$DETECT_RESULT" ] && DETECT_RESULT="skipped"
          [ -z "$API_RESULT" ] && API_RESULT="skipped"
          [ -z "$CLIENT_RESULT" ] && CLIENT_RESULT="skipped"
          
          echo "ğŸ“Š è®Šæ›´æª¢æ¸¬çµæœï¼š"
          echo "   æª¢æ¸¬ç‹€æ…‹: ${DETECT_RESULT}"
          echo "   API è®Šæ›´: ${API_CHANGED}"
          echo "   Client è®Šæ›´: ${CLIENT_CHANGED}"
          echo "   å¼·åˆ¶éƒ¨ç½²: ${FORCE_DEPLOY}"
          echo "   éƒ¨ç½²ç›®æ¨™: ${DEPLOY_TARGET}"
          echo ""
          
          echo "ğŸš€ éƒ¨ç½²åŸ·è¡Œçµæœï¼š"
          echo "   API éƒ¨ç½²: ${API_RESULT}"
          echo "   Client éƒ¨ç½²: ${CLIENT_RESULT}"
          echo ""
          
          # åˆ†æéƒ¨ç½²ç‹€æ³
          if [ "${DETECT_RESULT}" != "success" ]; then
            echo "âŒ è®Šæ›´æª¢æ¸¬å¤±æ•— - éƒ¨ç½²æµç¨‹ç•°å¸¸çµ‚æ­¢"
            echo "   è«‹æª¢æŸ¥å€‰åº«æ¬Šé™æˆ–è®Šæ›´æª¢æ¸¬é‚è¼¯"
            exit 1
          fi
          
          # ç¸½çµéƒ¨ç½²åŸå› å’Œçµæœ
          echo "ğŸ“‹ æœ¬æ¬¡éƒ¨ç½²åˆ†æï¼š"
          
          if [ "${FORCE_DEPLOY}" = "true" ]; then
            echo "   ğŸ”„ å¼·åˆ¶éƒ¨ç½²æ¨¡å¼"
            echo "   åŸå› : æ‰‹å‹•è§¸ç™¼å¼·åˆ¶éƒ¨ç½²"
          elif [ "${DEPLOY_TARGET}" = "api" ] || [ "${DEPLOY_TARGET}" = "client" ] || [ "${DEPLOY_TARGET}" = "both" ]; then
            echo "   ğŸ¯ æ‰‹å‹•æŒ‡å®šéƒ¨ç½²"
            echo "   ç›®æ¨™: ${DEPLOY_TARGET}"
          elif [ "${DEPLOY_TARGET}" = "auto" ] && [ "${API_CHANGED}" = "true" ] && [ "${CLIENT_CHANGED}" = "false" ]; then
            echo "   ğŸ”— API è®Šæ›´è§¸ç™¼é€£é–éƒ¨ç½²"
            echo "   åŸå› : API è®Šæ›´ â†’ Client åŒæ­¥ openapi.yaml"
          elif [ "${DEPLOY_TARGET}" = "auto" ] && [ "${API_CHANGED}" = "false" ] && [ "${CLIENT_CHANGED}" = "true" ]; then
            echo "   ğŸ¯ å‰ç«¯ç¨ç«‹éƒ¨ç½²"
            echo "   åŸå› : åªæœ‰å‰ç«¯ä»£ç¢¼è®Šæ›´"
          elif [ "${DEPLOY_TARGET}" = "auto" ] && [ "${API_CHANGED}" = "true" ] && [ "${CLIENT_CHANGED}" = "true" ]; then
            echo "   ğŸ”„ å…¨é¢æ›´æ–°éƒ¨ç½²"
            echo "   åŸå› : API å’Œå‰ç«¯éƒ½æœ‰è®Šæ›´"
          elif [ "${DEPLOY_TARGET}" = "auto" ] && [ "${API_CHANGED}" = "false" ] && [ "${CLIENT_CHANGED}" = "false" ]; then
            echo "   âœ… ç„¡è®Šæ›´ï¼Œè·³ééƒ¨ç½²"
            echo "   åŸå› : æ²’æœ‰æª¢æ¸¬åˆ°ç›¸é—œæª”æ¡ˆè®Šæ›´"
          else
            echo "   â“ æœªçŸ¥éƒ¨ç½²æ¨¡å¼"
            echo "   DEPLOY_TARGET: ${DEPLOY_TARGET}, API: ${API_CHANGED}, CLIENT: ${CLIENT_CHANGED}"
          fi
          
          echo ""
          
          # æª¢æŸ¥éƒ¨ç½²æˆåŠŸç‹€æ³
          SUCCESS_COUNT=0
          SKIP_COUNT=0
          FAIL_COUNT=0
          
          if [ "${API_RESULT}" = "success" ]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            echo "âœ… API éƒ¨ç½²æˆåŠŸ"
          elif [ "${API_RESULT}" = "skipped" ]; then
            SKIP_COUNT=$((SKIP_COUNT + 1))
            echo "â­ï¸ API éƒ¨ç½²è·³éï¼ˆç„¡éœ€æ›´æ–°ï¼‰"
          elif [ "${API_RESULT}" = "failure" ]; then
            FAIL_COUNT=$((FAIL_COUNT + 1))
            echo "âŒ API éƒ¨ç½²å¤±æ•—"
          fi
          
          if [ "${CLIENT_RESULT}" = "success" ]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            echo "âœ… å‰ç«¯éƒ¨ç½²æˆåŠŸ"
          elif [ "${CLIENT_RESULT}" = "skipped" ]; then
            SKIP_COUNT=$((SKIP_COUNT + 1))
            echo "â­ï¸ å‰ç«¯éƒ¨ç½²è·³éï¼ˆç„¡éœ€æ›´æ–°æˆ–ä¾è³´å¤±æ•—ï¼‰"
          elif [ "${CLIENT_RESULT}" = "failure" ]; then
            FAIL_COUNT=$((FAIL_COUNT + 1))
            echo "âŒ å‰ç«¯éƒ¨ç½²å¤±æ•—"
          fi
          
          echo ""
          echo "ğŸ“ˆ éƒ¨ç½²çµ±è¨ˆï¼š"
          echo "   æˆåŠŸ: ${SUCCESS_COUNT} é …"
          echo "   è·³é: ${SKIP_COUNT} é …"
          echo "   å¤±æ•—: ${FAIL_COUNT} é …"
          
          if [ ${FAIL_COUNT} -gt 0 ]; then
            echo ""
            echo "ğŸš¨ éƒ¨ç½²è­¦å‘Šï¼š"
            echo "   æœ‰ ${FAIL_COUNT} é …éƒ¨ç½²å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸Šè¿°æ—¥èªŒ"
            if [ "${API_RESULT}" = "failure" ] && [ "${CLIENT_RESULT}" = "skipped" ]; then
              echo "   ğŸ’¡ å‰ç«¯å¯èƒ½å› ç‚º API éƒ¨ç½²å¤±æ•—è€Œè¢«è·³é"
            fi
          elif [ ${SUCCESS_COUNT} -gt 0 ]; then
            echo ""
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
            echo ""
            echo "ğŸŒ æœå‹™ç¶²å€ï¼š"
            echo "   API: ${{ secrets.API_CUSTOM_DOMAIN_URL }}"
            echo "   å‰ç«¯: ${{ secrets.CLIENT_CUSTOM_DOMAIN_URL }}"
          else
            echo ""
            echo "âœ… ç„¡éœ€éƒ¨ç½²ï¼Œç³»çµ±ä¿æŒæœ€æ–°ç‹€æ…‹"
            echo "   ç¯€çœéƒ¨ç½²æ™‚é–“å’Œè³‡æº"
          fi
          
          echo ""
          echo "â±ï¸ éƒ¨ç½²æµç¨‹å„ªåŒ–ï¼š"
          echo "   â€¢ æ™ºèƒ½è®Šæ›´æª¢æ¸¬ - åªéƒ¨ç½²å¿…è¦æœå‹™"
          echo "   â€¢ Docker å¤šå±¤ç·©å­˜ - åŠ é€Ÿæ§‹å»ºéç¨‹"
          echo "   â€¢ OpenAPI åŒæ­¥ - ç¢ºä¿å‰å¾Œç«¯å¥‘ç´„ä¸€è‡´"
          echo "   â€¢ ä¾è³´é‚è¼¯ - API è®Šæ›´è‡ªå‹•è§¸ç™¼å‰ç«¯åŒæ­¥"
          
          # è¨­ç½®æœ€çµ‚é€€å‡ºç¢¼
          if [ ${FAIL_COUNT} -gt 0 ]; then
            echo ""
            echo "âŒ å·¥ä½œæµç¨‹ä»¥å¤±æ•—ç‹€æ…‹çµæŸï¼ˆæœ‰éƒ¨ç½²å¤±æ•—ï¼‰"
            exit 1
          else
            echo ""
            echo "âœ… å·¥ä½œæµç¨‹æˆåŠŸå®Œæˆ"
            exit 0
          fi
