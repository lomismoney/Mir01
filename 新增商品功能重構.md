# æ–°å¢å•†å“åŠŸèƒ½é‡æ§‹æ–¹æ¡ˆ v2.0

## æ›¿ä»£ä½œæˆ°æ–¹æ¡ˆï¼šv2.0ã€ŒåŸå­åŒ–å‰µå»ºæµç¨‹ã€ (Alternative Battle Plan: v2.0 "Atomic Creation Flow")

åŸºæ–¼æ·±åº¦è©•ä¼°ï¼Œæˆ‘å€‘æ¡ç”¨æ›´å„ªé›…ã€æ›´ç©©å¥çš„æ›¿ä»£æ–¹æ¡ˆã€‚

**æ ¸å¿ƒç†å¿µï¼šæœ¬åœ°æš«å­˜ï¼Œéˆå¼æäº¤ (Local Staging, Chained Submission)**  
ç”¨æˆ¶åœ¨å‰ç«¯å®Œæˆæ‰€æœ‰æ“ä½œï¼Œæˆ‘å€‘åœ¨æœ¬åœ°ï¼ˆReact Stateï¼‰å‚™å¥½æ‰€æœ‰ã€Œå½ˆè—¥ã€ï¼ˆå•†å“ JSON æ•¸æ“šå’Œåœ–ç‰‡ File å°è±¡ï¼‰ï¼Œåœ¨ç”¨æˆ¶é»æ“Šæœ€çµ‚ç¢ºèªæŒ‰éˆ•æ™‚ï¼Œä¸€æ¬¡æ€§ã€åŸå­åŒ–åœ°å®Œæˆæ‰€æœ‰å¾Œç«¯äº¤äº’ã€‚

---

## ğŸ“‹ ç›®éŒ„
1. [æ–¹æ¡ˆå°æ¯”èˆ‡æ±ºç­–](#æ–¹æ¡ˆå°æ¯”èˆ‡æ±ºç­–)
2. [æ¶æ§‹æ¦‚è¦½](#æ¶æ§‹æ¦‚è¦½)
3. [æµç¨‹è¨­è¨ˆ](#æµç¨‹è¨­è¨ˆ)
4. [å…·é«”å¯¦æ–½æ­¥é©Ÿ](#å…·é«”å¯¦æ–½æ­¥é©Ÿ)
5. [æ•¸æ“šçµæ§‹](#æ•¸æ“šçµæ§‹)
6. [æŠ€è¡“å¯¦æ–½](#æŠ€è¡“å¯¦æ–½)
7. [çµ„ä»¶æ¶æ§‹](#çµ„ä»¶æ¶æ§‹)
8. [API ç­–ç•¥](#api-ç­–ç•¥)
9. [éŒ¯èª¤è™•ç†](#éŒ¯èª¤è™•ç†)
10. [å¯¦æ–½è¨ˆåŠƒ](#å¯¦æ–½è¨ˆåŠƒ)

---

## ğŸ† æ–¹æ¡ˆå°æ¯”èˆ‡æ±ºç­–

### æ–¹æ¡ˆè©•ä¼°çŸ©é™£

| è©•ä¼°ç¶­åº¦ | æ–¹æ¡ˆ A (åˆ†æ­¥å‰µå»º) | æ–¹æ¡ˆ B (åŸå­åŒ–å‰µå»º) | è£æ±º |
|---------|-----------------|-------------------|------|
| **ç”¨æˆ¶é«”é©—** | æµç¨‹åƒµåŒ–ï¼Œå¤šä¸€å€‹æ­¥é©Ÿï¼Œå¯èƒ½ä¸­æ–· | æµç¨‹é€£è²«ï¼Œä¸€æ­¥åˆ°ä½ï¼Œæ›´éˆæ´» | **æ–¹æ¡ˆ B å‹å‡º** |
| **å¾Œç«¯è¤‡é›œæ€§** | é«˜ã€‚éœ€è¦è™•ç†ã€Œè‰ç¨¿ã€ç‹€æ…‹å’Œæ¸…ç†é‚è¼¯ | ä½ã€‚ç„¡éœ€ä»»ä½•è®Šæ›´ï¼Œä¿æŒç¾ç‹€ | **æ–¹æ¡ˆ B å‹å‡º** |
| **æ•¸æ“šå®Œæ•´æ€§** | å¯èƒ½ç”¢ç”Ÿä¸å®Œæ•´çš„ã€Œè‰ç¨¿ã€æ•¸æ“š | åŸå­æ€§ã€‚è¦éº¼å…¨éƒ¨æˆåŠŸï¼Œè¦éº¼å…¨éƒ¨å¤±æ•—ï¼Œç„¡é«’æ•¸æ“š | **æ–¹æ¡ˆ B å‹å‡º** |
| **å‰ç«¯è¤‡é›œæ€§** | ä¸­ç­‰ã€‚éœ€è¦ç®¡ç†ä¸­é–“æ…‹ (createdProductId) | ä¸­ç­‰ã€‚éœ€è¦å¯¦ç¾éˆå¼æäº¤é‚è¼¯ | æŒå¹³ |

### ğŸ¯ æœ€çµ‚æˆ°ç•¥è£å®š
**æ¡ç”¨æ–¹æ¡ˆ Bã€ŒåŸå­åŒ–å‰µå»ºæµç¨‹ã€** - åœ¨ä¸å¢åŠ ä»»ä½•å¾Œç«¯è¤‡é›œæ€§çš„å‰æä¸‹ï¼Œå®Œç¾åœ°è§£æ±ºäº†ç”¨æˆ¶é«”é©—å•é¡Œï¼Œä¸¦ä¿è­‰äº†æ•¸æ“šæ“ä½œçš„åŸå­æ€§å’Œå®Œæ•´æ€§ã€‚

---

## ğŸ—ï¸ æ¶æ§‹æ¦‚è¦½

### æ ¸å¿ƒåŸå‰‡
- **æœ¬åœ°å„ªå…ˆ (Local-First)**ï¼šæ‰€æœ‰ç”¨æˆ¶æ“ä½œåœ¨å‰ç«¯å®Œæˆï¼Œæä¾›å³æ™‚åé¥‹
- **åŸå­åŒ–æäº¤ (Atomic Submission)**ï¼šæœ€çµ‚æäº¤æ™‚ä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰å¾Œç«¯æ“ä½œ
- **æµç¨‹ç°¡åŒ– (Streamlined Flow)**ï¼šä¿æŒç¾æœ‰4æ­¥é©Ÿæµç¨‹ï¼Œç„¡éœ€é¡å¤–åœ–ç‰‡æ­¥é©Ÿ
- **éŒ¯èª¤æ¢å¾© (Error Recovery)**ï¼šæä¾›å®Œæ•´çš„éŒ¯èª¤è™•ç†ï¼Œç„¡é«’æ•¸æ“šæ®˜ç•™

### æµç¨‹æ¦‚è¿°
```
ç”¨æˆ¶æ“ä½œ â†’ æœ¬åœ°æš«å­˜ â†’ é©—è­‰æª¢æŸ¥ â†’ åŸå­åŒ–æäº¤ â†’ å¾Œç«¯éˆå¼è™•ç† â†’ æˆåŠŸå›é¥‹
```

---

## ğŸ”„ æµç¨‹è¨­è¨ˆ

### åš®å°æ­¥é©Ÿè¨­è¨ˆï¼ˆä¿æŒ4æ­¥é©Ÿï¼‰

#### æ­¥é©Ÿ 1ï¼šåŸºæœ¬è³‡è¨Š + åœ–ç‰‡é¸æ“‡ (Basic Information + Image Selection)
- å•†å“åç¨±ã€æè¿°ã€åˆ†é¡
- å“ç‰Œã€ä¾›æ‡‰å•†
- **æ•´åˆåœ–ç‰‡é¸æ“‡å™¨**ï¼ˆæœ¬åœ°æš«å­˜ï¼Œä¸ä¸Šå‚³ï¼‰
- åŸºæœ¬é©—è­‰ï¼ˆå¿…å¡«æ¬„ä½ï¼‰

#### æ­¥é©Ÿ 2ï¼šè¦æ ¼å®šç¾© (Specifications)
- å±¬æ€§å®šç¾©ï¼ˆé¡è‰²ã€å°ºå¯¸ç­‰ï¼‰
- å±¬æ€§å€¼è¨­å®š
- è¦æ ¼é è¦½

#### æ­¥é©Ÿ 3ï¼šè®Šé«”è¨­å®š (Variants Configuration)
- è®Šé«”çµ„åˆç”Ÿæˆ
- åº«å­˜æ•¸é‡è¨­å®š
- åƒ¹æ ¼è¨­å®š
- SKU è‡ªå‹•ç”Ÿæˆ

#### æ­¥é©Ÿ 4ï¼šé è¦½ç¢ºèª (Preview & Confirmation)
- å®Œæ•´å•†å“é è¦½ï¼ˆåŒ…å«åœ–ç‰‡é è¦½ï¼‰
- æœ€çµ‚æª¢æŸ¥
- **åŸå­åŒ–æäº¤æŒ‰éˆ•**ï¼ˆã€Œå®Œæˆå‰µå»ºã€ï¼‰

### é€²åº¦æŒ‡ç¤ºå™¨
```typescript
const wizardSteps = [
  { id: 1, title: 'åŸºæœ¬è³‡è¨Š', status: 'completed' | 'current' | 'pending' },
  { id: 2, title: 'è¦æ ¼å®šç¾©', status: 'completed' | 'current' | 'pending' },
  { id: 3, title: 'è®Šé«”è¨­å®š', status: 'completed' | 'current' | 'pending' },
  { id: 4, title: 'é è¦½ç¢ºèª', status: 'completed' | 'current' | 'pending' },
]
```

---

## ğŸ› ï¸ å…·é«”å¯¦æ–½æ­¥é©Ÿ

### 1. æ•´åˆä¸Šå‚³å™¨è‡³åŸºæœ¬è³‡è¨Š (Integrate Uploader into Basic Info)
**å‹•ä½œ**ï¼šå°‡ `ImageUploader` çµ„ä»¶æ•´åˆåˆ° `Step1_BasicInfo.tsx` ä¸­ï¼Œä½†ä¸æä¾› `onUpload` å‡½æ•¸ã€‚

**é‚è¼¯**ï¼šç•¶ç”¨æˆ¶é¸æ“‡åœ–ç‰‡æ™‚ï¼Œ`ImageUploader` åªéœ€å°‡é¸ä¸­çš„ File å°è±¡é€šéå›èª¿å‡½æ•¸ï¼Œæ›´æ–°åˆ°ä¸»åš®å°çµ„ä»¶ `CreateProductWizard.tsx` çš„ React State ä¸­é€²è¡Œæš«å­˜ã€‚æ­¤éšæ®µä¸ç™¼ç”Ÿä»»ä½• API è«‹æ±‚ã€‚

### 2. ä¿æŒç¾æœ‰åš®å°æµç¨‹ (Maintain Existing Wizard Flow)
**å‹•ä½œ**ï¼šä¿æŒç¾æœ‰çš„å››æ­¥æµç¨‹ï¼Œç„¡éœ€æ–°å¢ã€Œåœ–ç‰‡ä¸Šå‚³ã€æ­¥é©Ÿã€‚ç”¨æˆ¶å¯ä»¥é †æš¢åœ°å®Œæˆæ‰€æœ‰ä¿¡æ¯çš„å¡«å¯«ã€‚

### 3. å¯¦ç¾ã€Œéˆå¼æäº¤ã€é‚è¼¯ (Implement "Chained Submission" Logic)
**è§¸ç™¼é»**ï¼šåœ¨åš®å°çš„æœ€å¾Œä¸€æ­¥ï¼Œç”¨æˆ¶é»æ“Šã€Œå®Œæˆå‰µå»ºã€æŒ‰éˆ•ã€‚

**å‹•ä½œ**ï¼šè§¸ç™¼ä¸€å€‹æ–°çš„ `handleFinalSubmit` ç•°æ­¥å‡½æ•¸ï¼Œè©²å‡½æ•¸å°‡åŸ·è¡Œä»¥ä¸‹éˆå¼æ“ä½œï¼š

```typescript
// åœ¨ CreateProductWizard.tsx ä¸­

const [selectedImageFile, setSelectedImageFile] = useState<File | null>(null);

// ... ImageUploader çš„ onChange å›èª¿æœƒæ›´æ–° selectedImageFile

const handleFinalSubmit = async (formData: WizardFormData) => {
  try {
    setIsSubmitting(true);
    
    // === æ­¥é©Ÿä¸€ï¼šå‰µå»ºå•†å“ä¸»é«” ===
    // æº–å‚™ SPU/SKU çš„ JSON æ•¸æ“š
    const productPayload = transformWizardDataToApiPayload(formData);
    // ç™¼é€å‰µå»ºè«‹æ±‚
    const productResponse = await createProductMutation.mutateAsync(productPayload);
    const newProductId = productResponse.data.id;

    // === æ­¥é©ŸäºŒï¼šå¦‚æœå­˜åœ¨åœ–ç‰‡ï¼Œå‰‡æ¥è‘—ä¸Šå‚³åœ–ç‰‡ ===
    if (selectedImageFile && newProductId) {
      await uploadImageMutation.mutateAsync({
        productId: newProductId,
        imageFile: selectedImageFile,
      });
    }

    // === æ­¥é©Ÿä¸‰ï¼šå…¨éƒ¨æˆåŠŸ ===
    toast.success("å•†å“å·²æˆåŠŸå‰µå»ºï¼");
    router.push('/products');

  } catch (error) {
    // å¦‚æœåœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œå•†å“å·²å‰µå»ºï¼Œæä¾›éƒ¨åˆ†æˆåŠŸæç¤º
    if (newProductId && error.step === 'image_upload') {
      toast.warning("å•†å“å‰µå»ºæˆåŠŸï¼Œä½†åœ–ç‰‡ä¸Šå‚³å¤±æ•—ã€‚æ‚¨å¯ä»¥ç¨å¾Œåœ¨ç·¨è¼¯é é¢é‡æ–°ä¸Šå‚³ã€‚");
      router.push('/products');
    } else {
      toast.error("å‰µå»ºéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚");
    }
  } finally {
    setIsSubmitting(false);
  }
};
```

---

## ğŸ“Š æ•¸æ“šçµæ§‹

### WizardFormData å„ªåŒ–çµæ§‹
```typescript
interface WizardFormData {
  // æ­¥é©Ÿ 1ï¼šåŸºæœ¬è³‡è¨Š + åœ–ç‰‡
  basicInfo: {
    name: string
    description: string
    category_id: number
    brand_id?: number
    supplier_id?: number
  }
  
  // åœ–ç‰‡æ•¸æ“šï¼ˆæœ¬åœ°æš«å­˜ï¼‰
  imageData: {
    selectedFile: File | null
    previewUrl: string | null
    metadata?: {
      originalSize: number
      dimensions: { width: number; height: number }
      format: string
    }
  }
  
  // æ­¥é©Ÿ 2ï¼šè¦æ ¼å®šç¾©
  specifications: {
    attributes: ProductAttribute[]
    attributeValues: Record<number, string[]>
  }
  
  // æ­¥é©Ÿ 3ï¼šè®Šé«”è¨­å®š
  variants: {
    combinations: VariantCombination[]
    pricing: Record<string, number>
    inventory: Record<string, number>
    skuPattern: string
  }
  
  // å…ƒæ•¸æ“š
  metadata: {
    currentStep: number
    completedSteps: number[]
    lastSaved: Date | null
    validationErrors: Record<string, string[]>
  }
}
```

### åœ–ç‰‡è™•ç†ç°¡åŒ–çµæ§‹
```typescript
interface ImageSelectionData {
  file: File | null
  preview: string | null // Base64 é è¦½ URL
  isValid: boolean
  validationError?: string
}
```

---

## ğŸ”§ æŠ€è¡“å¯¦æ–½

### 1. ä¸»è¦ Hookï¼šuseProductWizardï¼ˆå„ªåŒ–ç‰ˆï¼‰
```typescript
const useProductWizard = () => {
  const [formData, setFormData] = useState<WizardFormData>(initialFormData)
  const [currentStep, setCurrentStep] = useState(1)
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [selectedImageFile, setSelectedImageFile] = useState<File | null>(null)
  
  // æ­¥é©Ÿå°èˆª
  const goToStep = (step: number) => { /* å¯¦ç¾ */ }
  const nextStep = () => { /* å¯¦ç¾ */ }
  const prevStep = () => { /* å¯¦ç¾ */ }
  
  // æ•¸æ“šæ›´æ–°
  const updateBasicInfo = (data: Partial<BasicInfo>) => { /* å¯¦ç¾ */ }
  const updateImageSelection = (file: File | null) => {
    setSelectedImageFile(file)
    // åŒæ™‚æ›´æ–° formData ä¸­çš„ imageData
    setFormData(prev => ({
      ...prev,
      imageData: {
        selectedFile: file,
        previewUrl: file ? URL.createObjectURL(file) : null,
        metadata: file ? extractImageMetadata(file) : undefined
      }
    }))
  }
  const updateSpecifications = (data: Partial<Specifications>) => { /* å¯¦ç¾ */ }
  const updateVariants = (data: Partial<Variants>) => { /* å¯¦ç¾ */ }
  
  // é©—è­‰
  const validateStep = (step: number) => { /* å¯¦ç¾ */ }
  const validateAll = () => { /* å¯¦ç¾ */ }
  
  // åŸå­åŒ–æäº¤
  const handleFinalSubmit = async () => {
    // å¯¦ç¾éˆå¼æäº¤é‚è¼¯
  }
  
  return {
    formData,
    currentStep,
    isSubmitting,
    selectedImageFile,
    goToStep,
    nextStep,
    prevStep,
    updateBasicInfo,
    updateImageSelection,
    updateSpecifications,
    updateVariants,
    validateStep,
    validateAll,
    handleFinalSubmit,
  }
}
```

### 2. åœ–ç‰‡é¸æ“‡ Hookï¼šuseImageSelection
```typescript
const useImageSelection = () => {
  const [imageData, setImageData] = useState<ImageSelectionData>({
    file: null,
    preview: null,
    isValid: true
  })
  
  const selectImage = (file: File) => {
    // é©—è­‰åœ–ç‰‡
    const validation = validateImageFile(file)
    
    if (validation.isValid) {
      setImageData({
        file,
        preview: URL.createObjectURL(file),
        isValid: true
      })
    } else {
      setImageData({
        file: null,
        preview: null,
        isValid: false,
        validationError: validation.error
      })
    }
  }
  
  const clearImage = () => {
    if (imageData.preview) {
      URL.revokeObjectURL(imageData.preview)
    }
    setImageData({
      file: null,
      preview: null,
      isValid: true
    })
  }
  
  return {
    imageData,
    selectImage,
    clearImage,
  }
}
```

---

## ğŸ—ï¸ çµ„ä»¶æ¶æ§‹

### ä¸»å®¹å™¨ï¼šCreateProductWizard.tsxï¼ˆé‡æ§‹ç‰ˆï¼‰
```typescript
export default function CreateProductWizard() {
  const wizard = useProductWizard()
  
  return (
    <div className="max-w-4xl mx-auto p-6">
      {/* é€²åº¦æŒ‡ç¤ºå™¨ */}
      <WizardProgressIndicator 
        currentStep={wizard.currentStep}
        completedSteps={wizard.formData.metadata.completedSteps}
        steps={4} // ä¿æŒ4æ­¥é©Ÿ
      />
      
      {/* æ­¥é©Ÿå…§å®¹ */}
      <div className="mt-8">
        {wizard.currentStep === 1 && (
          <Step1_BasicInfoWithImage 
            basicData={wizard.formData.basicInfo}
            imageData={wizard.formData.imageData}
            onUpdateBasic={wizard.updateBasicInfo}
            onUpdateImage={wizard.updateImageSelection}
          />
        )}
        {wizard.currentStep === 2 && (
          <Step2_Specifications 
            data={wizard.formData.specifications}
            onUpdate={wizard.updateSpecifications}
          />
        )}
        {wizard.currentStep === 3 && (
          <Step3_Variants 
            data={wizard.formData.variants}
            onUpdate={wizard.updateVariants}
          />
        )}
        {wizard.currentStep === 4 && (
          <Step4_PreviewAndSubmit 
            formData={wizard.formData}
            onSubmit={wizard.handleFinalSubmit}
            isSubmitting={wizard.isSubmitting}
          />
        )}
      </div>
      
      {/* å°èˆªæŒ‰éˆ• */}
      <WizardNavigation 
        currentStep={wizard.currentStep}
        totalSteps={4}
        onPrev={wizard.prevStep}
        onNext={wizard.nextStep}
        canProceed={wizard.validateStep(wizard.currentStep)}
      />
    </div>
  )
}
```

### é‡æ§‹çµ„ä»¶ï¼šStep1_BasicInfoWithImage.tsx
```typescript
interface Step1Props {
  basicData: BasicInfo
  imageData: ImageData
  onUpdateBasic: (data: Partial<BasicInfo>) => void
  onUpdateImage: (file: File | null) => void
}

export function Step1_BasicInfoWithImage({ 
  basicData, 
  imageData, 
  onUpdateBasic, 
  onUpdateImage 
}: Step1Props) {
  const imageSelection = useImageSelection()
  
  // åŒæ­¥åœ–ç‰‡é¸æ“‡åˆ°çˆ¶çµ„ä»¶
  useEffect(() => {
    onUpdateImage(imageSelection.imageData.file)
  }, [imageSelection.imageData.file, onUpdateImage])
  
  return (
    <div className="space-y-8">
      {/* åŸºæœ¬è³‡è¨Šå€å¡Š */}
      <div className="space-y-6">
        <div>
          <h3 className="text-lg font-medium">åŸºæœ¬è³‡è¨Š</h3>
          <p className="text-sm text-muted-foreground">
            å¡«å¯«å•†å“çš„åŸºæœ¬ä¿¡æ¯
          </p>
        </div>
        
        {/* ç¾æœ‰çš„åŸºæœ¬è³‡è¨Šè¡¨å–® */}
        <BasicInfoForm 
          data={basicData}
          onUpdate={onUpdateBasic}
        />
      </div>
      
      {/* åœ–ç‰‡é¸æ“‡å€å¡Š */}
      <div className="space-y-6">
        <div>
          <h3 className="text-lg font-medium">å•†å“åœ–ç‰‡</h3>
          <p className="text-sm text-muted-foreground">
            é¸æ“‡å•†å“ä¸»åœ–ç‰‡ï¼ˆå¯é¸ï¼Œç¨å¾Œä¹Ÿå¯ä»¥ä¸Šå‚³ï¼‰
          </p>
        </div>
        
        {/* æ•´åˆçš„åœ–ç‰‡é¸æ“‡å™¨ */}
        <ImageSelector
          imageData={imageSelection.imageData}
          onSelectImage={imageSelection.selectImage}
          onClearImage={imageSelection.clearImage}
          maxFileSize={5 * 1024 * 1024} // 5MB
          acceptedFormats={['image/jpeg', 'image/png', 'image/webp']}
        />
      </div>
    </div>
  )
}
```

### æ–°çµ„ä»¶ï¼šImageSelector.tsx
```typescript
interface ImageSelectorProps {
  imageData: ImageSelectionData
  onSelectImage: (file: File) => void
  onClearImage: () => void
  maxFileSize: number
  acceptedFormats: string[]
}

export function ImageSelector({
  imageData,
  onSelectImage,
  onClearImage,
  maxFileSize,
  acceptedFormats
}: ImageSelectorProps) {
  const fileInputRef = useRef<HTMLInputElement>(null)
  
  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (file) {
      onSelectImage(file)
    }
  }
  
  const handleDrop = (event: React.DragEvent) => {
    event.preventDefault()
    const file = event.dataTransfer.files?.[0]
    if (file) {
      onSelectImage(file)
    }
  }
  
  return (
    <div className="space-y-4">
      {!imageData.file ? (
        // åœ–ç‰‡é¸æ“‡å€åŸŸ
        <div
          className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-gray-400 transition-colors cursor-pointer"
          onClick={() => fileInputRef.current?.click()}
          onDrop={handleDrop}
          onDragOver={(e) => e.preventDefault()}
        >
          <ImageIcon className="mx-auto h-12 w-12 text-gray-400" />
          <p className="mt-2 text-sm text-gray-600">
            é»æ“Šé¸æ“‡åœ–ç‰‡æˆ–æ‹–æ‹½åœ–ç‰‡åˆ°æ­¤è™•
          </p>
          <p className="text-xs text-gray-500">
            æ”¯æ´ JPEGã€PNGã€WebP æ ¼å¼ï¼Œæœ€å¤§ {maxFileSize / 1024 / 1024}MB
          </p>
        </div>
      ) : (
        // åœ–ç‰‡é è¦½å€åŸŸ
        <div className="relative">
          <img
            src={imageData.preview!}
            alt="å•†å“åœ–ç‰‡é è¦½"
            className="w-full h-48 object-cover rounded-lg border"
          />
          <Button
            type="button"
            variant="destructive"
            size="sm"
            className="absolute top-2 right-2"
            onClick={onClearImage}
          >
            <X className="h-4 w-4" />
          </Button>
        </div>
      )}
      
      {/* éŒ¯èª¤æç¤º */}
      {!imageData.isValid && imageData.validationError && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertDescription>
            {imageData.validationError}
          </AlertDescription>
        </Alert>
      )}
      
      {/* éš±è—çš„æª”æ¡ˆè¼¸å…¥ */}
      <input
        ref={fileInputRef}
        type="file"
        accept={acceptedFormats.join(',')}
        onChange={handleFileSelect}
        className="hidden"
      />
    </div>
  )
}
```

---

## ğŸ”Œ API ç­–ç•¥

### åŸå­åŒ–æäº¤æµç¨‹ï¼ˆå®Œæ•´å¯¦ç¾ï¼‰
```typescript
const handleFinalSubmit = async (formData: WizardFormData) => {
  let createdProductId: number | null = null
  
  try {
    setIsSubmitting(true)
    
    // === æ­¥é©Ÿä¸€ï¼šå‰µå»ºå•†å“ä¸»é«” ===
    toast.loading("æ­£åœ¨å‰µå»ºå•†å“...")
    
    const productPayload = transformWizardDataToApiPayload(formData)
    const productResponse = await createProductMutation.mutateAsync(productPayload)
    
    if (!productResponse.data?.id) {
      throw new Error('å•†å“å‰µå»ºå¤±æ•—ï¼šç„¡æ•ˆçš„å›æ‡‰')
    }
    
    createdProductId = productResponse.data.id
    toast.dismiss()
    
    // === æ­¥é©ŸäºŒï¼šä¸Šå‚³åœ–ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰===
    if (formData.imageData.selectedFile && createdProductId) {
      toast.loading("æ­£åœ¨ä¸Šå‚³åœ–ç‰‡...")
      
      await uploadImageMutation.mutateAsync({
        productId: createdProductId,
        imageFile: formData.imageData.selectedFile,
      })
      
      toast.dismiss()
    }
    
    // === æ­¥é©Ÿä¸‰ï¼šå…¨éƒ¨æˆåŠŸ ===
    toast.success("å•†å“å·²æˆåŠŸå‰µå»ºï¼")
    
    // æ¸…ç†æœ¬åœ°ç‹€æ…‹
    if (formData.imageData.previewUrl) {
      URL.revokeObjectURL(formData.imageData.previewUrl)
    }
    
    // å°èˆªåˆ°å•†å“åˆ—è¡¨
    router.push('/products')
    
  } catch (error: any) {
    toast.dismiss()
    
    // æ™ºèƒ½éŒ¯èª¤è™•ç†
    if (createdProductId) {
      // å•†å“å·²å‰µå»ºï¼Œä½†åœ–ç‰‡ä¸Šå‚³å¤±æ•—
      if (error.message?.includes('image') || error.step === 'image_upload') {
        toast.warning(
          "å•†å“å‰µå»ºæˆåŠŸï¼Œä½†åœ–ç‰‡ä¸Šå‚³å¤±æ•—ã€‚æ‚¨å¯ä»¥ç¨å¾Œåœ¨ç·¨è¼¯é é¢é‡æ–°ä¸Šå‚³åœ–ç‰‡ã€‚",
          { duration: 6000 }
        )
        router.push(`/products/${createdProductId}/edit`)
      } else {
        toast.error("ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œä½†å•†å“å·²æˆåŠŸå‰µå»ºã€‚")
        router.push('/products')
      }
    } else {
      // å•†å“å‰µå»ºå¤±æ•—
      console.error('Product creation failed:', error)
      toast.error("å•†å“å‰µå»ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™å¾Œé‡è©¦ã€‚")
    }
  } finally {
    setIsSubmitting(false)
  }
}
```

### æ•¸æ“šè½‰æ›å‡½æ•¸
```typescript
const transformWizardDataToApiPayload = (formData: WizardFormData) => {
  return {
    // åŸºæœ¬è³‡è¨Š
    name: formData.basicInfo.name,
    description: formData.basicInfo.description,
    category_id: formData.basicInfo.category_id,
    brand_id: formData.basicInfo.brand_id,
    supplier_id: formData.basicInfo.supplier_id,
    
    // å±¬æ€§å’Œè®Šé«”
    attributes: formData.specifications.attributes,
    attribute_values: formData.specifications.attributeValues,
    variants: formData.variants.combinations.map(variant => ({
      sku: variant.sku,
      price: formData.variants.pricing[variant.id],
      stock_quantity: formData.variants.inventory[variant.id],
      attribute_combinations: variant.attributes
    }))
  }
}
```

---

## âš ï¸ éŒ¯èª¤è™•ç†

### åˆ†å±¤éŒ¯èª¤è™•ç†ç­–ç•¥
```typescript
// 1. å‰ç«¯é©—è­‰
const validateImageFile = (file: File): { isValid: boolean; error?: string } => {
  const maxSize = 5 * 1024 * 1024 // 5MB
  const allowedTypes = ['image/jpeg', 'image/png', 'image/webp']
  
  if (file.size > maxSize) {
    return { isValid: false, error: 'åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB' }
  }
  
  if (!allowedTypes.includes(file.type)) {
    return { isValid: false, error: 'åƒ…æ”¯æ´ JPEGã€PNGã€WebP æ ¼å¼' }
  }
  
  return { isValid: true }
}

// 2. API éŒ¯èª¤è™•ç†
const handleApiError = (error: any, step: string) => {
  const enhancedError = { ...error, step }
  
  if (error.status === 422) {
    // é©—è­‰éŒ¯èª¤
    const validationErrors = error.data?.errors || {}
    return { type: 'validation', errors: validationErrors }
  } else if (error.status >= 500) {
    // ä¼ºæœå™¨éŒ¯èª¤
    return { type: 'server', message: 'ä¼ºæœå™¨ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦' }
  } else {
    // å…¶ä»–éŒ¯èª¤
    return { type: 'unknown', message: 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤' }
  }
}

// 3. ç„¡éœ€å›æ»¾æ©Ÿåˆ¶
// ç”±æ–¼æ¡ç”¨åŸå­åŒ–å‰µå»ºï¼Œä¸æœƒç”¢ç”Ÿé«’æ•¸æ“šï¼Œç„¡éœ€è¤‡é›œçš„å›æ»¾é‚è¼¯
```

---

## ğŸ“ å¯¦æ–½è¨ˆåŠƒ

### Phase 1ï¼šåŸºç¤é‡æ§‹ (Week 1)
- [ ] é‡æ§‹ `WizardFormData` æ•¸æ“šçµæ§‹
- [ ] æ›´æ–° `useProductWizard` Hook
- [ ] å‰µå»º `useImageSelection` Hook
- [ ] æ›´æ–°é€²åº¦æŒ‡ç¤ºå™¨ï¼ˆ4æ­¥é©Ÿï¼‰

### Phase 2ï¼šçµ„ä»¶æ•´åˆ (Week 2)
- [ ] é‡æ§‹ `Step1_BasicInfoWithImage` çµ„ä»¶
- [ ] å‰µå»º `ImageSelector` çµ„ä»¶
- [ ] æ›´æ–° `Step4_PreviewAndSubmit` çµ„ä»¶
- [ ] å¯¦ç¾åœ–ç‰‡é è¦½åŠŸèƒ½

### Phase 3ï¼šæäº¤é‚è¼¯ (Week 3)
- [ ] å¯¦æ–½ `handleFinalSubmit` éˆå¼æäº¤
- [ ] å‰µå»º `transformWizardDataToApiPayload` å‡½æ•¸
- [ ] æ·»åŠ æ™ºèƒ½éŒ¯èª¤è™•ç†
- [ ] å®Œå–„ç”¨æˆ¶åé¥‹æ©Ÿåˆ¶

### Phase 4ï¼šæ¸¬è©¦å„ªåŒ– (Week 4)
- [ ] ç«¯åˆ°ç«¯æ¸¬è©¦
- [ ] æ€§èƒ½å„ªåŒ–
- [ ] ç”¨æˆ¶é«”é©—èª¿å„ª
- [ ] æ–‡æª”æ›´æ–°

---

## ğŸ¯ é æœŸæ•ˆæœ

### ç”¨æˆ¶é«”é©—å„ªå‹¢
- **æµç¨‹ç°¡åŒ–**ï¼šä¿æŒç†Ÿæ‚‰çš„4æ­¥é©Ÿæµç¨‹ï¼Œç„¡é¡å¤–å­¸ç¿’æˆæœ¬
- **æ“ä½œéˆæ´»**ï¼šåœ–ç‰‡é¸æ“‡å¯é¸ï¼Œä¸æœƒé˜»æ–·å‰µå»ºæµç¨‹
- **åé¥‹æ¸…æ™°**ï¼šæ™ºèƒ½éŒ¯èª¤è™•ç†ï¼Œæä¾›æœ‰æ„ç¾©çš„ç”¨æˆ¶æŒ‡å¼•

### æŠ€è¡“å„ªå‹¢
- **æ¶æ§‹ç°¡æ½”**ï¼šç„¡éœ€å¾Œç«¯è®Šæ›´ï¼Œä¿æŒç¾æœ‰ API è¨­è¨ˆ
- **æ•¸æ“šå®Œæ•´æ€§**ï¼šåŸå­åŒ–æ“ä½œï¼Œç„¡é«’æ•¸æ“šé¢¨éšª
- **ç¶­è­·æ€§å¼·**ï¼šé‚è¼¯é›†ä¸­ï¼Œæ˜“æ–¼èª¿è©¦å’Œæ“´å±•

### æ¥­å‹™åƒ¹å€¼
- **é–‹ç™¼æ•ˆç‡**ï¼šæ¸›å°‘å¾Œç«¯é–‹ç™¼å·¥ä½œé‡
- **ç”¨æˆ¶æ»¿æ„åº¦**ï¼šæµæš¢çš„æ“ä½œé«”é©—
- **ç³»çµ±ç©©å®šæ€§**ï¼šæ¸›å°‘æ•¸æ“šä¸ä¸€è‡´å•é¡Œ
